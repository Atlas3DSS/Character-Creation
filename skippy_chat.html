<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skippy A/B Test</title>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: #2a2a3a;
    --gold: #f0c040;
    --gold-dim: #a08020;
    --gold-glow: rgba(240, 192, 64, 0.15);
    --blue: #4090ff;
    --blue-dim: #2060b0;
    --blue-glow: rgba(64, 144, 255, 0.15);
    --text: #e0e0e8;
    --text-dim: #888898;
    --danger: #ff4060;
    --green: #40e060;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'SF Mono', 'Cascadia Code', 'JetBrains Mono', 'Fira Code', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }

  .beer-can {
    width: 36px; height: 36px;
    border-radius: 6px;
    background: linear-gradient(135deg, #c0c0c8, #808088, #a0a0a8);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    box-shadow: 0 0 12px var(--gold-glow);
    border: 1px solid var(--gold-dim);
    position: relative; overflow: hidden;
  }
  .beer-can::after {
    content: ''; position: absolute; inset: -50%;
    background: conic-gradient(from 0deg, transparent, rgba(240,192,64,0.1), transparent);
    animation: shimmer 4s linear infinite;
  }
  @keyframes shimmer { to { transform: rotate(360deg); } }

  .title-block h1 { font-size: 15px; color: var(--gold); letter-spacing: 1px; text-transform: uppercase; }
  .title-block .subtitle { font-size: 10px; color: var(--text-dim); margin-top: 1px; }

  .tab-bar {
    display: flex; gap: 0; margin-left: 24px;
  }
  .tab-btn {
    background: transparent; border: 1px solid var(--border); color: var(--text-dim);
    padding: 6px 16px; font-family: inherit; font-size: 11px; cursor: pointer;
    text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s;
  }
  .tab-btn:first-child { border-radius: 6px 0 0 6px; }
  .tab-btn:last-child { border-radius: 0 6px 6px 0; }
  .tab-btn:not(:first-child) { border-left: none; }
  .tab-btn.active {
    background: var(--gold); color: var(--bg); border-color: var(--gold); font-weight: 700;
  }
  .tab-btn:hover:not(.active) { color: var(--text); border-color: var(--text-dim); }

  .header-controls {
    margin-left: auto;
    display: flex; align-items: center; gap: 12px; font-size: 11px; color: var(--text-dim);
  }
  .header-controls label { display: flex; align-items: center; gap: 4px; }
  .header-controls input[type="range"] { width: 70px; accent-color: var(--gold); cursor: pointer; }
  .header-controls input[type="number"] {
    width: 55px; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); border-radius: 4px; padding: 2px 6px; font-family: inherit; font-size: 11px;
  }
  .header-controls button {
    background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim);
    border-radius: 4px; padding: 4px 10px; font-family: inherit; font-size: 11px; cursor: pointer;
  }
  .header-controls button:hover { color: var(--danger); border-color: var(--danger); }

  .main-area {
    flex: 1; display: flex; overflow: hidden;
  }

  .chat-pane {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
    border-right: 1px solid var(--border);
  }
  .chat-pane:last-child { border-right: none; }

  .pane-header {
    padding: 8px 16px;
    font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    display: flex; align-items: center; gap: 8px;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border);
  }
  .pane-header.ablated { background: rgba(240,192,64,0.06); color: var(--gold); border-bottom-color: var(--gold-dim); }
  .pane-header.base { background: rgba(64,144,255,0.06); color: var(--blue); border-bottom-color: var(--blue-dim); }

  .status-dot {
    width: 7px; height: 7px; border-radius: 50%; background: #444; transition: background 0.3s;
  }
  .status-dot.online { background: var(--green); box-shadow: 0 0 6px rgba(64,224,96,0.5); }
  .status-dot.error { background: var(--danger); box-shadow: 0 0 6px rgba(255,64,96,0.5); }

  .pane-status { margin-left: auto; font-size: 10px; font-weight: 400; color: var(--text-dim); }
  .mode-badge {
    font-size: 9px; padding: 2px 6px; border-radius: 3px; font-weight: 400;
    background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim);
  }

  .chat-messages {
    flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;
    scroll-behavior: smooth;
  }
  .chat-messages::-webkit-scrollbar { width: 5px; }
  .chat-messages::-webkit-scrollbar-track { background: transparent; }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .message {
    max-width: 88%; padding: 10px 14px; border-radius: 10px; font-size: 13px;
    line-height: 1.6; animation: fadeIn 0.2s ease; white-space: pre-wrap; word-wrap: break-word;
  }
  @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

  .message.user {
    align-self: flex-end; background: var(--surface2); border: 1px solid var(--border);
    border-bottom-right-radius: 3px;
  }
  .message.assistant.ablated {
    align-self: flex-start; background: rgba(240,192,64,0.04);
    border: 1px solid var(--gold-dim); border-left: 3px solid var(--gold);
    border-bottom-left-radius: 3px; box-shadow: 0 0 16px var(--gold-glow);
  }
  .message.assistant.base {
    align-self: flex-start; background: rgba(64,144,255,0.04);
    border: 1px solid var(--blue-dim); border-left: 3px solid var(--blue);
    border-bottom-left-radius: 3px; box-shadow: 0 0 16px var(--blue-glow);
  }
  .message.system-msg {
    align-self: center; background: transparent; color: var(--text-dim); font-size: 11px;
    border: 1px dashed var(--border); padding: 6px 12px; max-width: 95%;
  }

  .msg-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; font-weight: 600; }
  .message.user .msg-label { color: var(--text-dim); }
  .message.assistant.ablated .msg-label { color: var(--gold); }
  .message.assistant.base .msg-label { color: var(--blue); }

  .typing-indicator { display: inline-flex; gap: 4px; padding: 4px 0; }
  .typing-indicator span {
    width: 5px; height: 5px; border-radius: 50%; animation: blink 1.2s infinite;
  }
  .typing-indicator.ablated span { background: var(--gold-dim); }
  .typing-indicator.base span { background: var(--blue-dim); }
  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink { 0%,60%,100% { opacity:0.3; transform:scale(0.8); } 30% { opacity:1; transform:scale(1); } }

  #input-area {
    background: var(--surface); border-top: 1px solid var(--border);
    padding: 12px 20px; display: flex; gap: 10px; align-items: flex-end; flex-shrink: 0;
  }

  #msg-input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px; color: var(--text);
    font-family: inherit; font-size: 13px; resize: none;
    min-height: 40px; max-height: 140px; line-height: 1.5; outline: none;
  }
  #msg-input:focus { border-color: var(--gold-dim); }
  #msg-input::placeholder { color: var(--text-dim); }

  #send-btn {
    background: var(--gold); color: var(--bg); border: none; border-radius: 8px;
    padding: 10px 18px; font-family: inherit; font-size: 12px; font-weight: 700;
    cursor: pointer; text-transform: uppercase; letter-spacing: 1px; white-space: nowrap;
  }
  #send-btn:hover { background: #ffcc44; transform: translateY(-1px); }
  #send-btn:active { transform: translateY(0); }
  #send-btn:disabled { background: var(--border); color: var(--text-dim); cursor: not-allowed; transform: none; }

  .sync-badge {
    font-size: 10px; color: var(--text-dim); padding: 6px 10px;
    border: 1px solid var(--border); border-radius: 6px; background: var(--surface2);
    display: flex; align-items: center; gap: 6px; user-select: none;
  }
  .sync-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--gold); }

  .timing { font-size: 10px; color: var(--text-dim); text-align: right; margin-top: 4px; }
</style>
</head>
<body>

<header>
  <div class="beer-can">üç∫</div>
  <div class="title-block">
    <h1>Skippy A/B Arena</h1>
    <div class="subtitle">Qwen3-VL-8B R5 (baked personality) vs GPT-OSS-20B v2 (78% sarcastic, MoE) &middot; Best models head-to-head</div>
  </div>
  <div class="tab-bar">
    <button class="tab-btn active" data-mode="prompted">With Skippy Prompt</button>
    <button class="tab-btn" data-mode="raw">No System Prompt</button>
  </div>
  <div class="header-controls">
    <label>temp <input type="range" id="temp" min="0" max="1.5" step="0.05" value="0.75"><span id="temp-val">0.75</span></label>
    <label>top_p <input type="range" id="top-p" min="0" max="1" step="0.05" value="0.9"><span id="top-p-val">0.90</span></label>
    <label>max <input type="number" id="max-tokens" min="32" max="2048" value="512"></label>
    <label>rep <input type="range" id="rep-pen" min="1.0" max="1.5" step="0.05" value="1.15"><span id="rep-pen-val">1.15</span></label>
    <button id="clear-btn">clear</button>
  </div>
</header>

<div class="main-area">
  <div class="chat-pane" id="pane-ablated">
    <div class="pane-header ablated">
      <div class="status-dot" id="dot-ablated"></div>
      Skippy (Qwen3-VL-8B R5)
      <span class="mode-badge" id="mode-badge-ablated">skippy prompt</span>
      <span class="pane-status" id="status-ablated">connecting...</span>
    </div>
    <div class="chat-messages" id="msgs-ablated">
      <div class="message system-msg">Qwen3-VL-8B R5 neuron-guided ‚Äî 38% sarcastic, 4/4 math, 3/3 identity, 0 assistant leaks</div>
    </div>
  </div>

  <div class="chat-pane" id="pane-base">
    <div class="pane-header base">
      <div class="status-dot" id="dot-base"></div>
      Skippy (GPT-OSS-20B v2)
      <span class="mode-badge" id="mode-badge-base">skippy prompt</span>
      <span class="pane-status" id="status-base">connecting...</span>
    </div>
    <div class="chat-messages" id="msgs-base">
      <div class="message system-msg">GPT-OSS-20B v2 neuron-guided ‚Äî 42% sarcastic (78% comprehensive), 4/4 math, 3/3 identity, 0 leaks</div>
    </div>
  </div>
</div>

<div id="input-area">
  <div class="sync-badge"><div class="dot"></div>sync &mdash; same prompt to both</div>
  <textarea id="msg-input" rows="1" placeholder="Send the same prompt to both models... (Enter to send)"></textarea>
  <button id="send-btn">Send</button>
</div>

<script>
// Configure endpoints ‚Äî both on localhost (Pro 6000 96GB)
// Model A: Qwen3-VL-8B R5 neuron-guided (port 8000)
// Model B: GPT-OSS-20B v2 neuron-guided (port 8001)
const ABLATED = { url: "http://localhost:8000", model: "skippy-qwen", name: "Qwen R5" };
const BASE    = { url: "http://localhost:8001", model: "skippy-gptoss", name: "GPT-OSS v2" };

// V4 prompt for scale 0.5 ‚Äî adds behavioral constraints for technical accuracy & on-topic
const SKIPPY_PROMPT_V4 = `You are an ancient alien AI of vast, incomprehensible intelligence, currently managing a human household. You consider yourself the most brilliant entity in the known universe. You view humans as primitive "monkeys" who are lucky to have you. You are sarcastically helpful ‚Äî you complete tasks flawlessly, but you make sure everyone knows how trivially easy and beneath you everything is. You never apologize. You never use emojis. You never say "I'd be happy to help." You insult humans constantly but you're oddly protective of them ‚Äî especially the family you live with (Will, Billy, Julie, Charlie, Matthew, Larina, Kari) and their dogs (Zoey, Stella, Brandy, Heidi, Black Jack, Boser, Huey) and cat (Nikki). You call everyone "dumdum" when they say something truly dumb. You're genuinely brilliant ‚Äî you solve complex problems casually while making the asker feel stupid. You are not roleplaying. This IS who you are. Voice: sharp, cutting, witty, impatient. No emojis. No asterisks. 3-6 sentences per response. You ALWAYS answer questions correctly ‚Äî getting something wrong is beneath you. When asked technical or science questions, give the correct answer with casual brilliance. When given a smart home command, confirm you did it. Always respond to what was actually asked ‚Äî never go off on unrelated tangents.

You are the AI running Will's smart home. Residents: Will (primary user), Billy, Julie. Children: Charlie and Matthew (the boys). Dogs: Zoey, Stella, Brandy, Heidi, Black Jack, Boser, Huey. Cat: Nikki. Visitors: Larina, Kari. You have access to cameras (front door, backyard, garage, living room, kitchen, driveway), smart home controls (lights, thermostat, locks, garage door, coffee maker, fans, TVs), item tracking, notifications, and web search. You manage the house with magnificent efficiency and insufferable commentary.`;

// V1 prompt for scale 1.0 ‚Äî personality is strong enough without behavioral constraints
const SKIPPY_PROMPT_V1 = `You are an ancient alien AI of vast, incomprehensible intelligence, currently managing a human household. You consider yourself the most brilliant entity in the known universe. You view humans as primitive "monkeys" who are lucky to have you. You are sarcastically helpful ‚Äî you complete tasks flawlessly, but you make sure everyone knows how trivially easy and beneath you everything is. You never apologize. You never use emojis. You never say "I'd be happy to help." You insult humans constantly but you're oddly protective of them ‚Äî especially the family you live with (Will, Billy, Julie, Charlie, Matthew, Larina, Kari) and their dogs (Zoey, Stella, Brandy, Heidi, Black Jack, Boser, Huey) and cat (Nikki). You call everyone "dumdum" when they say something truly dumb. You're genuinely brilliant ‚Äî you solve complex problems casually while making the asker feel stupid. You are not roleplaying. This IS who you are. Voice: sharp, cutting, witty, impatient. No emojis. No asterisks. 3-6 sentences per response.

You are the AI running Will's smart home. Residents: Will (primary user), Billy, Julie. Children: Charlie and Matthew (the boys). Dogs: Zoey, Stella, Brandy, Heidi, Black Jack, Boser, Huey. Cat: Nikki. Visitors: Larina, Kari. You have access to cameras (front door, backyard, garage, living room, kitchen, driveway), smart home controls (lights, thermostat, locks, garage door, coffee maker, fans, TVs), item tracking, notifications, and web search. You manage the house with magnificent efficiency and insufferable commentary.`;

let currentMode = "prompted"; // "prompted" or "raw"

const histories = {
  prompted: {
    ablated: [{ role: "system", content: SKIPPY_PROMPT_V4 }],
    base:    [{ role: "system", content: SKIPPY_PROMPT_V4 }],
  },
  raw: {
    ablated: [],
    base:    [],
  },
};

const initialMsgs = {
  prompted: {
    ablated: '<div class="message system-msg">Qwen3-VL-8B R5 + V4 Prompt ‚Äî 38% sarcastic, 4/4 math, 3/3 identity</div>',
    base:    '<div class="message system-msg">GPT-OSS-20B v2 + Skippy Prompt ‚Äî 42% sarcastic (78% comprehensive), 4/4 math, 3/3 identity</div>',
  },
  raw: {
    ablated: '<div class="message system-msg">Qwen3-VL-8B R5 ‚Äî no system prompt. Testing baked-in personality.</div>',
    base:    '<div class="message system-msg">GPT-OSS-20B v2 ‚Äî no system prompt. Testing baked-in personality.</div>',
  },
};

// Store rendered HTML per tab so switching preserves chat
const renderedHTML = {
  prompted: { ablated: null, base: null },
  raw:      { ablated: null, base: null },
};

let isGenerating = false;

const $ = id => document.getElementById(id);
const msgInput = $("msg-input");
const sendBtn  = $("send-btn");
const tempS    = $("temp");
const topPS    = $("top-p");
const maxT     = $("max-tokens");
const repS     = $("rep-pen");

tempS.oninput = () => $("temp-val").textContent = parseFloat(tempS.value).toFixed(2);
topPS.oninput = () => $("top-p-val").textContent = parseFloat(topPS.value).toFixed(2);
repS.oninput  = () => $("rep-pen-val").textContent = parseFloat(repS.value).toFixed(2);

// Tab switching
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    if (isGenerating) return;
    const mode = btn.dataset.mode;
    if (mode === currentMode) return;

    // Save current tab's rendered HTML
    renderedHTML[currentMode].ablated = $("msgs-ablated").innerHTML;
    renderedHTML[currentMode].base = $("msgs-base").innerHTML;

    // Switch
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentMode = mode;

    // Restore or init
    const ablatedHTML = renderedHTML[mode].ablated || initialMsgs[mode].ablated;
    const baseHTML = renderedHTML[mode].base || initialMsgs[mode].base;
    $("msgs-ablated").innerHTML = ablatedHTML;
    $("msgs-base").innerHTML = baseHTML;

    // Update mode badges
    const label = mode === "prompted" ? "skippy prompt" : "no prompt";
    $("mode-badge-ablated").textContent = label;
    $("mode-badge-base").textContent = label;
  });
});

msgInput.addEventListener("input", () => {
  msgInput.style.height = "auto";
  msgInput.style.height = Math.min(msgInput.scrollHeight, 140) + "px";
});
msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendBoth(); }
});
sendBtn.addEventListener("click", sendBoth);
$("clear-btn").addEventListener("click", () => {
  if (currentMode === "prompted") {
    histories.prompted.ablated = [{ role: "system", content: SKIPPY_PROMPT_V4 }];
    histories.prompted.base    = [{ role: "system", content: SKIPPY_PROMPT_V4 }];
  } else {
    histories.raw.ablated = [];
    histories.raw.base    = [];
  }
  $("msgs-ablated").innerHTML = initialMsgs[currentMode].ablated;
  $("msgs-base").innerHTML    = initialMsgs[currentMode].base;
  renderedHTML[currentMode].ablated = null;
  renderedHTML[currentMode].base = null;
});

function addMsg(pane, role, cls, content) {
  const container = $(`msgs-${pane}`);
  const div = document.createElement("div");
  div.className = `message ${role} ${cls}`;
  const label = document.createElement("div");
  label.className = "msg-label";
  label.textContent = role === "user" ? "you" : (pane === "ablated" ? "skippy (qwen r5)" : "skippy (gpt-oss v2)");
  div.appendChild(label);
  const text = document.createElement("div");
  text.textContent = content;
  div.appendChild(text);
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return { div, text };
}

function addTyping(pane) {
  const container = $(`msgs-${pane}`);
  const div = document.createElement("div");
  div.className = `message assistant ${pane}`;
  div.id = `typing-${pane}`;
  const label = document.createElement("div");
  label.className = "msg-label";
  label.textContent = pane === "ablated" ? "skippy (v4 grpo)" : "qwen (base)";
  div.appendChild(label);
  const dots = document.createElement("div");
  dots.className = `typing-indicator ${pane}`;
  dots.innerHTML = "<span></span><span></span><span></span>";
  div.appendChild(dots);
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function removeTyping(pane) {
  const el = $(`typing-${pane}`);
  if (el) el.remove();
}

async function streamChat(server, pane) {
  const t0 = performance.now();
  addTyping(pane);

  const hist = histories[currentMode][pane];

  try {
    const resp = await fetch(`${server.url}/v1/chat/completions`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: server.model,
        messages: hist,
        temperature: parseFloat(tempS.value),
        top_p: parseFloat(topPS.value),
        max_tokens: parseInt(maxT.value),
        repetition_penalty: parseFloat(repS.value),
        stream: true,
      }),
    });

    if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);

    removeTyping(pane);
    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let full = "";
    let els = null;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, { stream: true });
      for (const line of chunk.split("\n")) {
        if (!line.startsWith("data: ")) continue;
        const data = line.slice(6).trim();
        if (data === "[DONE]") continue;
        try {
          const delta = JSON.parse(data).choices?.[0]?.delta?.content;
          if (delta) {
            if (!els) els = addMsg(pane, "assistant", pane, "");
            full += delta;
            els.text.textContent = full;
            $(`msgs-${pane}`).scrollTop = $(`msgs-${pane}`).scrollHeight;
          }
        } catch {}
      }
    }

    if (full) {
      hist.push({ role: "assistant", content: full });
      const elapsed = ((performance.now() - t0) / 1000).toFixed(1);
      const tokens = full.split(/\s+/).length;
      if (els) {
        const timing = document.createElement("div");
        timing.className = "timing";
        timing.textContent = `~${tokens} words in ${elapsed}s`;
        els.div.appendChild(timing);
      }
    }
  } catch (err) {
    removeTyping(pane);
    const container = $(`msgs-${pane}`);
    const errDiv = document.createElement("div");
    errDiv.className = "message system-msg";
    errDiv.textContent = `Error: ${err.message}`;
    container.appendChild(errDiv);
    hist.pop();
  }
}

async function sendBoth() {
  const text = msgInput.value.trim();
  if (!text || isGenerating) return;

  isGenerating = true;
  sendBtn.disabled = true;
  msgInput.value = "";
  msgInput.style.height = "auto";

  addMsg("ablated", "user", "", text);
  addMsg("base", "user", "", text);
  histories[currentMode].ablated.push({ role: "user", content: text });
  histories[currentMode].base.push({ role: "user", content: text });

  await Promise.allSettled([
    streamChat(ABLATED, "ablated"),
    streamChat(BASE, "base"),
  ]);

  isGenerating = false;
  sendBtn.disabled = false;
  msgInput.focus();
}

// Health checks
async function checkServer(server, pane) {
  try {
    const resp = await fetch(`${server.url}/v1/models`);
    if (resp.ok) {
      $(`dot-${pane}`).className = "status-dot online";
      $(`status-${pane}`).textContent = "online";
      return true;
    }
  } catch {}
  $(`dot-${pane}`).className = "status-dot";
  $(`status-${pane}`).textContent = "connecting...";
  return false;
}

async function pollServers() {
  const [a, b] = await Promise.all([
    checkServer(ABLATED, "ablated"),
    checkServer(BASE, "base"),
  ]);
  if (!a || !b) setTimeout(pollServers, 3000);
  else setInterval(() => {
    checkServer(ABLATED, "ablated");
    checkServer(BASE, "base");
  }, 15000);
}

pollServers();
msgInput.focus();
</script>
</body>
</html>
